<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-20mA Transmitter Calibration Helper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-section {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        label {
            width: 150px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.reset-btn {
            background-color: #f44336;
        }
        button.reset-btn:hover {
            background-color: #d32f2f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-size: 18px;
        }
        .large-font {
            font-size: 20px;
            font-weight: bold;
        }
        .small-font {
            font-size: 12px;
            font-style: italic;
            color: #666;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 60px;
            text-align: center;
        }
        .error-cell {
            background-color: #ffebee;
            border: 2px solid #f44336;
        }
        .spec-range {
            font-size: 12px;
            font-style: italic;
            color: #666;
        }
        .charts-section {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chart-container h3 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }
        canvas {
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>4-20mA Transmitter Calibration Helper</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label for="zero">Zero (4.00 mA):</label>
                <input type="number" id="zero" step="0.01" placeholder="Enter zero value">
            </div>
            <div class="input-group">
                <label for="fullScale">Full Scale (20.00 mA):</label>
                <input type="number" id="fullScale" step="0.01" placeholder="Enter full scale value">
            </div>
            <div class="input-group">
                <label for="spec">%F.S. Spec:</label>
                <input type="number" id="spec" step="0.001" placeholder="e.g., 0.5">
            </div>
            <div class="input-group">
                <button onclick="resetData()">Reset Data</button>
                <button onclick="resetAll()" class="reset-btn">Reset All</button>
            </div>
        </div>
        
        <table id="calibrationTable">
            <thead>
                <tr>
                    <th>% F.S.</th>
                    <th>Target Press</th>
                    <th>Cal Applied</th>
                    <th>Meas Press</th>
                    <th>Meas %F.S.</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="large-font">0</td>
                    <td id="target0"></td>
                    <td><input type="number" id="cal0" step="0.01" oninput="calculateDeviation(0)"></td>
                    <td><input type="number" id="meas0" step="0.01" oninput="calculateDeviation(0)"></td>
                    <td id="deviation0"></td>
                </tr>
                <tr>
                    <td class="large-font">25</td>
                    <td id="target25"></td>
                    <td><input type="number" id="cal25" step="0.01" oninput="calculateDeviation(25)"></td>
                    <td><input type="number" id="meas25" step="0.01" oninput="calculateDeviation(25)"></td>
                    <td id="deviation25"></td>
                </tr>
                <tr>
                    <td class="large-font">50</td>
                    <td id="target50"></td>
                    <td><input type="number" id="cal50" step="0.01" oninput="calculateDeviation(50)"></td>
                    <td><input type="number" id="meas50" step="0.01" oninput="calculateDeviation(50)"></td>
                    <td id="deviation50"></td>
                </tr>
                <tr>
                    <td class="large-font">75</td>
                    <td id="target75"></td>
                    <td><input type="number" id="cal75" step="0.01" oninput="calculateDeviation(75)"></td>
                    <td><input type="number" id="meas75" step="0.01" oninput="calculateDeviation(75)"></td>
                    <td id="deviation75"></td>
                </tr>
                <tr>
                    <td class="large-font">100</td>
                    <td id="target100"></td>
                    <td><input type="number" id="cal100" step="0.01" oninput="calculateDeviation(100)"></td>
                    <td><input type="number" id="meas100" step="0.01" oninput="calculateDeviation(100)"></td>
                    <td id="deviation100"></td>
                </tr>
            </tbody>
        </table>
        
        <!-- Charts section -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>% Deviation vs Data Point</h3>
                <canvas id="deviationChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Applied Pressure vs Measured Pressure</h3>
                <canvas id="pressureChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // Global variables to store input values
        let zeroValue = 0;
        let fullScaleValue = 0;
        let specValue = 0;
        let deviationChart = null;
        let pressureChart = null;
        
        // Add event listeners to input fields
        document.getElementById('zero').addEventListener('input', updateCalculations);
        document.getElementById('fullScale').addEventListener('input', updateCalculations);
        document.getElementById('spec').addEventListener('input', updateCalculations);
        
        // Initialize charts when page loads
        window.addEventListener('load', function() {
            createDeviationChart();
            createPressureChart();
        });
        
        function updateCalculations() {
            // Get input values
            zeroValue = parseFloat(document.getElementById('zero').value) || 0;
            fullScaleValue = parseFloat(document.getElementById('fullScale').value) || 0;
            specValue = parseFloat(document.getElementById('spec').value) || 0;
            
            // Calculate span
            const span = fullScaleValue - zeroValue;
            const specDelta = span * (specValue / 100);
            
            // Update target pressures for each percentage
            const percentages = [0, 25, 50, 75, 100];
            
            percentages.forEach(percent => {
                const targetPressure = zeroValue + (span * (percent / 100));
                const lowSpec = targetPressure - specDelta;
                const highSpec = targetPressure + specDelta;
                
                const targetCell = document.getElementById(`target${percent}`);
                targetCell.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold;">${targetPressure.toFixed(2)}</div>
                    <div class="spec-range">${lowSpec.toFixed(2)} to ${highSpec.toFixed(2)}</div>
                `;
            });
            
            // Recalculate all deviations
            percentages.forEach(percent => {
                calculateDeviation(percent);
            });
        }
        
        function calculateDeviation(percent) {
            // Get the measured pressure
            const measInput = document.getElementById(`meas${percent}`);
            const measValue = measInput.value ? parseFloat(measInput.value) : null;
            
            // If no measured value, clear the deviation cell and return
            if (measValue === null || isNaN(measValue)) {
                const deviationCell = document.getElementById(`deviation${percent}`);
                deviationCell.innerHTML = '';
                deviationCell.className = '';
                return;
            }
            
            // Get the calibration applied pressure (use default if blank)
            const calInput = document.getElementById(`cal${percent}`);
            const calValue = calInput.value ? parseFloat(calInput.value) : (zeroValue + (fullScaleValue - zeroValue) * (percent / 100));
            
            // Calculate the expected pressure for this percentage
            const expectedPressure = zeroValue + (fullScaleValue - zeroValue) * (percent / 100);
            
            // Calculate deviation as percentage of full scale
            const span = fullScaleValue - zeroValue;
            const deviation = ((measValue - calValue) / span) * 100;
            
            // Get the deviation cell
            const deviationCell = document.getElementById(`deviation${percent}`);
            
            // Format the deviation
            const formattedDeviation = deviation.toFixed(3) + '%';
            
            // Check if deviation exceeds spec (only if we have valid spec values)
            if (specValue > 0 && span > 0) {
                const specDelta = span * (specValue / 100);
                const specLimit = (specDelta / span) * 100; // Convert to %F.S.
                
                if (Math.abs(deviation) > specLimit) {
                    deviationCell.innerHTML = formattedDeviation;
                    deviationCell.className = 'error-cell';
                } else {
                    deviationCell.innerHTML = formattedDeviation;
                    deviationCell.className = '';
                }
            } else {
                deviationCell.innerHTML = formattedDeviation;
                deviationCell.className = '';
            }
        }
        
        function resetData() {
            if (confirm('Are you sure you want to reset all table data?')) {
                // Clear all input fields in the table
                const inputs = document.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    input.value = '';
                });
                
                // Clear all deviation cells
                const deviationCells = document.querySelectorAll('[id^="deviation"]');
                deviationCells.forEach(cell => {
                    cell.innerHTML = '';
                    cell.className = '';
                });
            }
        }
        
        function resetAll() {
            if (confirm('Are you sure you want to reset ALL data including Zero, Full Scale, and %F.S.?')) {
                // Clear all input fields
                document.getElementById('zero').value = '';
                document.getElementById('fullScale').value = '';
                document.getElementById('spec').value = '';
                
                // Clear table data
                resetData();
                
                // Clear target pressure cells
                const targetCells = document.querySelectorAll('[id^="target"]');
                targetCells.forEach(cell => {
                    cell.innerHTML = '';
                });
                
                // Reset global variables
                zeroValue = 0;
                fullScaleValue = 0;
                specValue = 0;
                
                // Clear charts
                updateDeviationChart();
                updatePressureChart();
            }
        }
        
        function createDeviationChart() {
            const ctx = document.getElementById('deviationChart').getContext('2d');
            deviationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0%', '25%', '50%', '75%', '100%'],
                    datasets: [{
                        label: '% Deviation',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '% Deviation'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data Point (%F.S.)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '% Deviation vs Data Point',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        function createPressureChart() {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            pressureChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Applied vs Measured',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Measured Pressure'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Applied Pressure'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Applied Pressure vs Measured Pressure',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        function updateDeviationChart() {
            if (!deviationChart) return;
            
            const percentages = [0, 25, 50, 75, 100];
            const deviations = [];
            
            percentages.forEach(percent => {
                const deviationCell = document.getElementById(`deviation${percent}`);
                const deviationText = deviationCell.textContent;
                
                if (deviationText) {
                    // Extract the numeric value from text like "0.123%"
                    const match = deviationText.match(/([-+]?\d+\.?\d*)%/);
                    deviations.push(match ? parseFloat(match[1]) : 0);
                } else {
                    deviations.push(null);
                }
            });
            
            deviationChart.data.datasets[0].data = deviations;
            deviationChart.update();
        }
        
        function updatePressureChart() {
            if (!pressureChart) return;
            
            const percentages = [0, 25, 50, 75, 100];
            const dataPoints = [];
            
            percentages.forEach(percent => {
                const calInput = document.getElementById(`cal${percent}`);
                const measInput = document.getElementById(`meas${percent}`);
                
                const calValue = calInput.value ? parseFloat(calInput.value) : (zeroValue + (fullScaleValue - zeroValue) * (percent / 100));
                const measValue = measInput.value ? parseFloat(measInput.value) : null;
                
                if (measValue !== null && !isNaN(measValue)) {
                    dataPoints.push({
                        x: calValue,
                        y: measValue
                    });
                }
            });
            
            pressureChart.data.datasets[0].data = dataPoints;
            pressureChart.update();
        }
        
        function updateCalculations() {
            // Get input values
            zeroValue = parseFloat(document.getElementById('zero').value) || 0;
            fullScaleValue = parseFloat(document.getElementById('fullScale').value) || 0;
            specValue = parseFloat(document.getElementById('spec').value) || 0;
            
            // Calculate span
            const span = fullScaleValue - zeroValue;
            const specDelta = span * (specValue / 100);
            
            // Update target pressures for each percentage
            const percentages = [0, 25, 50, 75, 100];
            
            percentages.forEach(percent => {
                const targetPressure = zeroValue + (span * (percent / 100));
                const lowSpec = targetPressure - specDelta;
                const highSpec = targetPressure + specDelta;
                
                const targetCell = document.getElementById(`target${percent}`);
                targetCell.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold;">${targetPressure.toFixed(2)}</div>
                    <div class="spec-range">${lowSpec.toFixed(2)} to ${highSpec.toFixed(2)}</div>
                `;
            });
            
            // Recalculate all deviations
            percentages.forEach(percent => {
                calculateDeviation(percent);
            });
            
            // Update charts
            updateDeviationChart();
            updatePressureChart();
        }
        
        function calculateDeviation(percent) {
            // Get the measured pressure
            const measInput = document.getElementById(`meas${percent}`);
            const measValue = measInput.value ? parseFloat(measInput.value) : null;
            
            // If no measured value, clear the deviation cell and return
            if (measValue === null || isNaN(measValue)) {
                const deviationCell = document.getElementById(`deviation${percent}`);
                deviationCell.innerHTML = '';
                deviationCell.className = '';
                updateDeviationChart();
                updatePressureChart();
                return;
            }
            
            // Get the calibration applied pressure (use default if blank)
            const calInput = document.getElementById(`cal${percent}`);
            const calValue = calInput.value ? parseFloat(calInput.value) : (zeroValue + (fullScaleValue - zeroValue) * (percent / 100));
            
            // Calculate the expected pressure for this percentage
            const expectedPressure = zeroValue + (fullScaleValue - zeroValue) * (percent / 100);
            
            // Calculate deviation as percentage of full scale
            const span = fullScaleValue - zeroValue;
            const deviation = ((measValue - calValue) / span) * 100;
            
            // Get the deviation cell
            const deviationCell = document.getElementById(`deviation${percent}`);
            
            // Format the deviation
            const formattedDeviation = deviation.toFixed(3) + '%';
            
            // Check if deviation exceeds spec (only if we have valid spec values)
            if (specValue > 0 && span > 0) {
                const specDelta = span * (specValue / 100);
                const specLimit = (specDelta / span) * 100; // Convert to %F.S.
                
                if (Math.abs(deviation) > specLimit) {
                    deviationCell.innerHTML = formattedDeviation;
                    deviationCell.className = 'error-cell';
                } else {
                    deviationCell.innerHTML = formattedDeviation;
                    deviationCell.className = '';
                }
            } else {
                deviationCell.innerHTML = formattedDeviation;
                deviationCell.className = '';
            }
            
            // Update charts
            updateDeviationChart();
            updatePressureChart();
        }
    </script>
</body>
</html>